<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hyperparameter Tuning &mdash; GPI: GenAI-Powered Inference 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=320156fd" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=01f34227"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/js/copybutton.js?v=a2f921dd"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Customizing Your Analysis" href="custom_imp.html" />
    <link rel="prev" title="Text-As-Treatment" href="tarnet.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="index.html" class="icon icon-home">
            GPI: GenAI-Powered Inference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#from-pypi">From PyPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#from-source">From Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#requirements">Requirements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gpi.html">What’s GPI?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gpi.html#generative-ai-powered-inference">Generative-AI Powered Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpi.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="startgpu.html">How to use GPU</a><ul>
<li class="toctree-l2"><a class="reference internal" href="startgpu.html#what-s-gpu">What’s GPU?</a></li>
<li class="toctree-l2"><a class="reference internal" href="startgpu.html#what-if-you-do-not-have-gpu">What if you do not have GPU?</a></li>
<li class="toctree-l2"><a class="reference internal" href="startgpu.html#id1">Google Colaboratory</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Generation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gen_llama.html">Generating Texts with LLaMa3</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gen_llama.html#how-to-use-llama3">How to use LLaMa3</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen_llama.html#creating-texts">Creating Texts</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen_llama.html#repeating-texts">Repeating Texts</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen_llama.html#arguments">Arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen_llama.html#system-prompts">System Prompts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gen_llm.html">Generating Texts with Other LLMs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gen_llm.html#example-gemma2">Example: Gemma2</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Basic Operation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tarnet.html">Text-As-Treatment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tarnet.html#what-is-text-as-treatment">What is Text-As-Treatment?</a></li>
<li class="toctree-l2"><a class="reference internal" href="tarnet.html#how-to-estimate-treatment-effects">How to estimate treatment effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="tarnet.html#how-to-control-confounders">How to control confounders</a></li>
<li class="toctree-l2"><a class="reference internal" href="tarnet.html#visualizing-propensity-scores">Visualizing Propensity Scores</a></li>
<li class="toctree-l2"><a class="reference internal" href="tarnet.html#hyperparameters">Hyperparameters</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Operations</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hyperparameter Tuning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#automated-hyperparameter-tuning">Automated Hyperparameter Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="#list-of-hyperparameters">List of Hyperparameters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="custom_imp.html">Customizing Your Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="custom_imp.html#tarnet">TarNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom_imp.html#propensity-score-model">Propensity Score Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom_imp.html#estimation-workflow">Estimation Workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quantization.html">When LLM is too big</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quantization.html#model-quantization">Model Quantization</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">references</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="f_dml_score.html">dml_score</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_estimate_k_ate.html">estimate_k_ate</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_estimate_psi_split.html">estimate_psi_split</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_extract_and_save_hiddens.html">extract_and_save_hiddens</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_generate_text.html">generate_text</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_get_instructions.html">get_instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_load_hiddens.html">load_hiddens</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_save_generated_texts.html">save_generated_texts</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_SpectralNormClassifier.html">SpectralNormClassifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_TarNet_loss.html">TarNet_loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_TarNet.html">TarNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_TarNetBase.html">TarNetBase</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_TarNetHyperparameterTuner.html">TarNetHyperparameterTuner</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GPI: GenAI-Powered Inference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Hyperparameter Tuning</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="hyperparameter-tuning">
<h1>Hyperparameter Tuning<a class="headerlink" href="#hyperparameter-tuning" title="Link to this heading"></a></h1>
<p>If you use our representation learning method (TarNet), we recommend you to tune the hyperparameters of the model. The hyperparameters are the parameters that are not learned during training, but are set before training. These parameters can have a significant impact on the performance of the model, and tuning changes the performance of <strong>deconfounder</strong>. In this section, we will introduce how to tune the hyperparameters of the model using <strong>gpi-pack</strong>.</p>
<section id="automated-hyperparameter-tuning">
<h2>Automated Hyperparameter Tuning<a class="headerlink" href="#automated-hyperparameter-tuning" title="Link to this heading"></a></h2>
<p>For the automated hyperparameter tuning, we use the existing framework called <a class="reference external" href="https://optuna.org/">Optuna</a>. <a class="reference external" href="https://optuna.org/">Optuna</a> is a hyperparameter optimization framework that is designed to be easy to use and flexible. If you have not installed <a class="reference external" href="https://optuna.org/">Optuna</a>, please install it using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>optuna
</pre></div>
</div>
<p>To use <a class="reference external" href="https://optuna.org/">Optuna</a>, we need to define the objective function that we want to optimize and the set of hyperparameters we want to fine-tune. You can use the class <code class="docutils literal notranslate"><span class="pre">TarNetHyperparameterTuner</span></code> to do this. The <code class="docutils literal notranslate"><span class="pre">TarNetHyperparameterTuner</span></code> class is a wrapper around the <a class="reference external" href="https://optuna.org/">Optuna</a> framework, and it provides a simple interface for defining the objective function and the hyperparameters. The following is an example of how to use the <code class="docutils literal notranslate"><span class="pre">TarNetHyperparameterTuner</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gpi_pack.TarNet</span> <span class="kn">import</span> <span class="n">TarNetHyperparameterTuner</span>
<span class="kn">import</span> <span class="nn">optuna</span>

<span class="c1"># Load data and set hyperparameters</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">TarNetHyperparameterTuner</span><span class="p">(</span>
    <span class="c1"># Data</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TreatmentVar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;OutcomeVar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="p">,</span>

    <span class="c1"># Hyperparameters</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;100&quot;</span><span class="p">,</span> <span class="s2">&quot;200&quot;</span><span class="p">],</span> <span class="c1">#try either 100 epochs or 200 epochs</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">],</span> <span class="c1">#draw learning rate in the range (1e-4, 1e-5)</span>
    <span class="n">dropout</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="c1">#draw dropout rate in the range (1e-4, 1e-5)</span>

    <span class="c1"># Outcome model architecture:</span>
    <span class="c1"># [100, 1] means that the deconfounder is passed to the intermediate layer with size 100,</span>
    <span class="c1"># and then it passes to the output layer with size 1.</span>
    <span class="n">architecture_y</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[200, 1]&quot;</span><span class="p">,</span> <span class="s2">&quot;[100,1]&quot;</span><span class="p">],</span> <span class="c1">#either [200, 1] or [100, 1] (size of layers)</span>

    <span class="c1">#Deconfounder model architecture:</span>
    <span class="c1"># [1024] means that the input (hidden states) is passed to the intermediate layer with size 1024.</span>
    <span class="c1"># The size of last layer (last number in the list) corresponds to the dimension of the deconfounder.</span>
    <span class="n">architecture_z</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[1024]&quot;</span><span class="p">,</span> <span class="s2">&quot;[2048]&quot;</span><span class="p">]</span> <span class="c1">#either [1024] or [2048]</span>
<span class="p">)</span>

<span class="c1"># Hyperparameter tuning with Optuna</span>
<span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;minimize&#39;</span><span class="p">)</span>
<span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="c1">#runs 100 trials to seek the best hyperparameter</span>

<span class="c1">#Print the best hyperparameters</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best hyperparameters: &quot;</span><span class="p">,</span> <span class="n">study</span><span class="o">.</span><span class="n">best_params</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="list-of-hyperparameters">
<h2>List of Hyperparameters<a class="headerlink" href="#list-of-hyperparameters" title="Link to this heading"></a></h2>
<p>The following is the list of hyperparameters that can be tuned using the <code class="docutils literal notranslate"><span class="pre">TarNetHyperparameterTuner</span></code> class:</p>
<table class="docutils align-center">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 40.0%" />
<col style="width: 35.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter Name</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Tuner Input Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">epoch</span></code></p></td>
<td><p>Number of epochs (pick up the best one from the list)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">epoch</span> <span class="pre">=</span> <span class="pre">[&quot;100&quot;,</span> <span class="pre">&quot;200&quot;]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">learning_rate</span></code></p></td>
<td><p>Range of learning rate (uniformly draw the best ones from the range)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">learning_rate</span> <span class="pre">=</span> <span class="pre">[1e-4,</span> <span class="pre">1e-5]</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">dropout</span></code></p></td>
<td><p>Range of dropout (uniformly draw the best ones from the range)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">dropout</span> <span class="pre">=</span> <span class="pre">[0.1,</span> <span class="pre">0.2]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">step_size</span></code></p></td>
<td><p>List of step sizes for learning rate scheduler</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">step_size</span> <span class="pre">=</span> <span class="pre">[100,</span> <span class="pre">200]</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">architecture_y</span></code></p></td>
<td><p>List of architectures for outcome models (pick up the best one from the list)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">architecture_y</span> <span class="pre">=</span> <span class="pre">[&quot;[256,</span> <span class="pre">128,</span> <span class="pre">1]&quot;,</span> <span class="pre">&quot;[128,</span> <span class="pre">64,</span> <span class="pre">1]&quot;]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">architecture_z</span></code></p></td>
<td><p>List of architectures for deconfoudner (pick up the best one from the list)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">architecture_z</span> <span class="pre">=</span> <span class="pre">[&quot;[2048]&quot;,</span> <span class="pre">&quot;[4096,</span> <span class="pre">2048]&quot;]</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">bn</span></code></p></td>
<td><p>List of batch normalization options (pick up the best one from the list)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">bn</span> <span class="pre">=</span> <span class="pre">[True,</span> <span class="pre">False]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">patience</span></code></p></td>
<td><p>The number of epochs to wait for improvement before stopping training</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">patience_max</span> <span class="pre">=</span> <span class="pre">20,</span> <span class="pre">patience_min</span> <span class="pre">=</span> <span class="pre">10</span></code></p></td>
</tr>
</tbody>
</table>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tarnet.html" class="btn btn-neutral float-left" title="Text-As-Treatment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="custom_imp.html" class="btn btn-neutral float-right" title="Customizing Your Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kentaro Nakamura, Kosuke Imai.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>